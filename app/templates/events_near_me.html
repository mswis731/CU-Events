{% extends 'navbar.html' %}

{% block title %} - Events Near Me{% endblock %}

{% block stylesheets %}
{% endblock %}


{% block content %}
<div class="container">
	<div class="col-md-5" >
		<form action="", method="post">
			<div class="form-group row">
					{{ form.radius.label }}
					{{ form.radius(class="selectpicker col-sm-4") }}
					{{ form.limit.label }}
					{{ form.limit(class="selectpicker col-sm-3") }}
					{{ form.submit(class="btn btn-primary") }}
			</div>
			<div class="form-group row">
				<div class="list-group" style="overflow:scroll; height:460px">
					{% for marker in markers %}
					<a href="{{ url_for('get_event', id=marker.eid) }}" class="list-group-item">{{ loop.index }}. {{ marker.title }}<span class="pull-right">{{'%0.2f'| format(marker.dist|float)}} mi</span></a>
					{% endfor %}
				</div>
			</div>
		</form>
	</div>
	<div class="col-md-7" >
		<div id="map" style="width: 600px; height: 600px;"></div>
	</div>
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true&key={{ key }}"></script>
<script type="text/javascript" async defer src="https://cdnjs.cloudflare.com/ajax/libs/gmaps.js/0.4.25/gmaps.min.js"></script>
<script type="text/javascript" async defer src="http://jawj.github.io/OverlappingMarkerSpiderfier/bin/oms.min.js"></script>
<script>
	var mapLibsReady = 0;
    //function mapLibReadyHandler() {
	$(document).ready(function(){
    	//if (++ mapLibsReady < 2) return;
    	var mapElement = document.getElementById('map');
    	var map = new google.maps.Map(mapElement, { center: { lat: {{ user_loc.lat }}, lng: {{ user_loc.lng }} }, zoom: 12 });
    	var iw = new google.maps.InfoWindow();
    	var oms = new OverlappingMarkerSpiderfier(map, { 
    		markersWontMove: true,   // we promise not to move any markers, allowing optimizations
    		markersWontHide: true,   // we promise not to change visibility of any markers, allowing optimizations
    		basicFormatEvents: true  // allow the library to skip calculating advanced formatting information
		});
      
		for (var i = 0, len = window.mapData.length; i < len; i ++) {
			(function() {  // make a closure over the marker and marker data
				var markerData = window.mapData[i];  // e.g. { lat: 50.123, lng: 0.123, text: 'XYZ' }
          		var marker = new google.maps.Marker({ position: markerData });  // markerData works here as a LatLngLiteral
				google.maps.event.addListener(marker, 'spider_click', function(e) {  // 'spider_click', not plain 'click'
					iw.setContent(markerData.text);
					iw.open(map, marker);
        		});
        		oms.addMarker(marker);  // adds the marker to the spiderfier _and_ the map
        	})();
      	}
      	window.map = map;  // for debugging/exploratory use in console
      	window.oms = oms;  // ditto
	//}
    });

   	var data = [];
	{% for marker in markers %}
	data.push({
		lat: {{ marker.loc.lat }},
		lng: {{ marker.loc.lng }},
		text: '{{ marker.title }}'
	});
	{% endfor %}
    window.mapData = data;
</script>
{% endblock %}
